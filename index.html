<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èª²å ‚æ¶ç­”ç³»çµ± - æ•™å¸«ç«¯</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      text-align: center;
      background-color: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
    }
    .leaderboard {
      margin: 30px 0;
      font-size: 24px;
    }
    .leaderboard table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .leaderboard th, .leaderboard td {
      padding: 15px;
      border: 1px solid #ddd;
    }
    .leaderboard th {
      background-color: #3498db;
      color: white;
    }
    .leaderboard tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .top3 {
      font-weight: bold;
      font-size: 28px;
    }
    .top3 .rank-1 { color: #e74c3c; }
    .top3 .rank-2 { color: #f39c12; }
    .top3 .rank-3 { color: #2ecc71; }
    .controls {
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      font-size: 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 0 10px;
    }
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 30px 0;
      text-align: left;
    }
    .stat-card {
      background-color: #ecf0f1;
      padding: 15px;
      border-radius: 8px;
    }
    .refresh-info {
      color: #7f8c8d;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>èª²å ‚æ¶ç­”ç³»çµ± - æ•™å¸«ç«¯</h1>
    
    <div class="controls">
      <button onclick="startQuiz()">é–‹å§‹æ–°æ¸¬é©—</button>
      <button onclick="refreshData()">åˆ·æ–°æ•¸æ“š</button>
    </div>
    
    <div class="top3" id="top3"></div>
    
    <div class="leaderboard">
      <h2>å³æ™‚æ’è¡Œæ¦œ</h2>
      <table id="leaderboardTable">
        <thead>
          <tr>
            <th>æ’å</th>
            <th>å­¸ç”Ÿå§“å</th>
            <th>ç­”å°é¡Œæ•¸</th>
            <th>ç¸½ç”¨æ™‚</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
    
    <div class="stats">
      <div class="stat-card">
        <h3>ç­”é¡Œçµ±è¨ˆ</h3>
        <div id="questionStats"></div>
      </div>
      <div class="stat-card">
        <h3>å­¸ç”Ÿåƒèˆ‡æƒ…æ³</h3>
        <div id="participationStats"></div>
      </div>
    </div>
    
    <div class="refresh-info">æ•¸æ“šæ¯10ç§’è‡ªå‹•åˆ·æ–°</div>
  </div>

  <script>
    let refreshInterval;
    const scriptUrl = "YOUR_APPS_SCRIPT_WEB_APP_URL";
    
    // é–‹å§‹æ–°æ¸¬é©— (æ¸…ç©ºä¹‹å‰çš„ç­”æ¡ˆ)
    function startQuiz() {
      if (confirm("ç¢ºå®šè¦é–‹å§‹æ–°æ¸¬é©—å—ï¼Ÿé€™å°‡æ¸…ç©ºä¹‹å‰çš„ç­”é¡Œè¨˜éŒ„ï¼")) {
        // é€™è£¡å¯ä»¥æ·»åŠ æ¸…ç©ºGoogle Sheetsçš„é‚è¼¯
        alert("æ–°æ¸¬é©—å·²é–‹å§‹ï¼");
        refreshData();
      }
    }
    
    // åˆ·æ–°æ•¸æ“š
    async function refreshData() {
      try {
        // å¾Google Sheetsç²å–å­¸ç”Ÿç­”æ¡ˆ
        const sheetId = "16F1OEvEoCfU0NA_e8XSd4uN0JXFUC9RElEUImiGLXc8";
        const sheetName = "student_answers";
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}&tqx=out:json`;
        
        const response = await fetch(url);
        const text = await response.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        
        const rows = json.table.rows;
        const answers = [];
        
        for (let i = 1; i < rows.length; i++) {
          const cells = rows[i].c;
          answers.push({
            name: cells[0]?.v || "",
            answer: cells[1]?.v || "",
            timestamp: cells[2]?.v || ""
          });
        }
        
        // è™•ç†æ•¸æ“šï¼Œè¨ˆç®—æ’å
        const students = {};
        answers.forEach(answer => {
          if (!students[answer.name]) {
            students[answer.name] = {
              correct: 0,
              time: 0,
              lastAnswerTime: new Date(answer.timestamp)
            };
          }
          
          // é€™è£¡ç°¡åŒ–è™•ç†ï¼Œå¯¦éš›æ‡‰æ ¹æ“šquestionsè¡¨åˆ¤æ–·å°éŒ¯
          students[answer.name].correct++;
          students[answer.name].time = (new Date(answer.timestamp) - students[answer.name].lastAnswerTime;
        });
        
        // è½‰æ›ç‚ºæ•¸çµ„ä¸¦æ’åº
        const leaderboard = Object.keys(students).map(name => ({
          name,
          correct: students[name].correct,
          time: students[name].time
        })).sort((a, b) => {
          if (b.correct !== a.correct) return b.correct - a.correct;
          return a.time - b.time;
        });
        
        // æ›´æ–°æ’è¡Œæ¦œ
        updateLeaderboard(leaderboard);
        
        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        updateStats(leaderboard, answers);
        
      } catch (error) {
        console.error("ç²å–æ•¸æ“šå¤±æ•—:", error);
      }
    }
    
    function updateLeaderboard(leaderboard) {
      const top3Div = document.getElementById("top3");
      const tbody = document.getElementById("leaderboardBody");
      
      // æ¸…ç©ºç¾æœ‰å…§å®¹
      top3Div.innerHTML = "";
      tbody.innerHTML = "";
      
      // é¡¯ç¤ºå‰ä¸‰å
      if (leaderboard.length > 0) {
        top3Div.innerHTML = `
          <div>ğŸ† ç¬¬ä¸€å: <span class="rank-1">${leaderboard[0].name}</span> (ç­”å° ${leaderboard[0].correct}é¡Œ)</div>
          ${leaderboard.length > 1 ? `<div>ğŸ¥ˆ ç¬¬äºŒå: <span class="rank-2">${leaderboard[1].name}</span> (ç­”å° ${leaderboard[1].correct}é¡Œ)</div>` : ''}
          ${leaderboard.length > 2 ? `<div>ğŸ¥‰ ç¬¬ä¸‰å: <span class="rank-3">${leaderboard[2].name}</span> (ç­”å° ${leaderboard[2].correct}é¡Œ)</div>` : ''}
        `;
      }
      
      // å¡«å……æ’è¡Œæ¦œè¡¨æ ¼
      leaderboard.forEach((student, index) => {
        const row = document.createElement("tr");
        if (index < 3) row.className = "top3";
        
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${student.name}</td>
          <td>${student.correct}</td>
          <td>${Math.floor(student.time / 1000)}ç§’</td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    function updateStats(leaderboard, answers) {
      // ç°¡åŒ–çš„çµ±è¨ˆæ•¸æ“šé¡¯ç¤º
      document.getElementById("questionStats").innerHTML = `
        <p>ç¸½ç­”é¡Œäººæ¬¡: ${answers.length}</p>
        <p>åƒèˆ‡å­¸ç”Ÿæ•¸: ${leaderboard.length}</p>
      `;
      
      document.getElementById("participationStats").
