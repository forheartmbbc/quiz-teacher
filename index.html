<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>課堂搶答系統 - 教師端</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      text-align: center;
      background-color: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
    }
    .leaderboard {
      margin: 30px 0;
      font-size: 24px;
    }
    .leaderboard table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .leaderboard th, .leaderboard td {
      padding: 15px;
      border: 1px solid #ddd;
    }
    .leaderboard th {
      background-color: #3498db;
      color: white;
    }
    .leaderboard tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .top3 {
      font-weight: bold;
      font-size: 28px;
    }
    .top3 .rank-1 { color: #e74c3c; }
    .top3 .rank-2 { color: #f39c12; }
    .top3 .rank-3 { color: #2ecc71; }
    .controls {
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      font-size: 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 0 10px;
    }
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 30px 0;
      text-align: left;
    }
    .stat-card {
      background-color: #ecf0f1;
      padding: 15px;
      border-radius: 8px;
    }
    .refresh-info {
      color: #7f8c8d;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>課堂搶答系統 - 教師端</h1>
    
    <div class="controls">
      <button onclick="startQuiz()">開始新測驗</button>
      <button onclick="refreshData()">刷新數據</button>
    </div>
    
    <div class="top3" id="top3"></div>
    
    <div class="leaderboard">
      <h2>即時排行榜</h2>
      <table id="leaderboardTable">
        <thead>
          <tr>
            <th>排名</th>
            <th>學生姓名</th>
            <th>答對題數</th>
            <th>總用時</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
    
    <div class="stats">
      <div class="stat-card">
        <h3>答題統計</h3>
        <div id="questionStats"></div>
      </div>
      <div class="stat-card">
        <h3>學生參與情況</h3>
        <div id="participationStats"></div>
      </div>
    </div>
    
    <div class="refresh-info">數據每10秒自動刷新</div>
  </div>

  <script>
    let refreshInterval;
    const scriptUrl = "YOUR_APPS_SCRIPT_WEB_APP_URL";
    
    // 開始新測驗 (清空之前的答案)
    function startQuiz() {
      if (confirm("確定要開始新測驗嗎？這將清空之前的答題記錄！")) {
        // 這裡可以添加清空Google Sheets的邏輯
        alert("新測驗已開始！");
        refreshData();
      }
    }
    
    // 刷新數據
    async function refreshData() {
      try {
        // 從Google Sheets獲取學生答案
        const sheetId = "16F1OEvEoCfU0NA_e8XSd4uN0JXFUC9RElEUImiGLXc8";
        const sheetName = "student_answers";
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}&tqx=out:json`;
        
        const response = await fetch(url);
        const text = await response.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        
        const rows = json.table.rows;
        const answers = [];
        
        for (let i = 1; i < rows.length; i++) {
          const cells = rows[i].c;
          answers.push({
            name: cells[0]?.v || "",
            answer: cells[1]?.v || "",
            timestamp: cells[2]?.v || ""
          });
        }
        
        // 處理數據，計算排名
        const students = {};
        answers.forEach(answer => {
          if (!students[answer.name]) {
            students[answer.name] = {
              correct: 0,
              time: 0,
              lastAnswerTime: new Date(answer.timestamp)
            };
          }
          
          // 這裡簡化處理，實際應根據questions表判斷對錯
          students[answer.name].correct++;
          students[answer.name].time = (new Date(answer.timestamp) - students[answer.name].lastAnswerTime;
        });
        
        // 轉換為數組並排序
        const leaderboard = Object.keys(students).map(name => ({
          name,
          correct: students[name].correct,
          time: students[name].time
        })).sort((a, b) => {
          if (b.correct !== a.correct) return b.correct - a.correct;
          return a.time - b.time;
        });
        
        // 更新排行榜
        updateLeaderboard(leaderboard);
        
        // 更新統計數據
        updateStats(leaderboard, answers);
        
      } catch (error) {
        console.error("獲取數據失敗:", error);
      }
    }
    
    function updateLeaderboard(leaderboard) {
      const top3Div = document.getElementById("top3");
      const tbody = document.getElementById("leaderboardBody");
      
      // 清空現有內容
      top3Div.innerHTML = "";
      tbody.innerHTML = "";
      
      // 顯示前三名
      if (leaderboard.length > 0) {
        top3Div.innerHTML = `
          <div>🏆 第一名: <span class="rank-1">${leaderboard[0].name}</span> (答對 ${leaderboard[0].correct}題)</div>
          ${leaderboard.length > 1 ? `<div>🥈 第二名: <span class="rank-2">${leaderboard[1].name}</span> (答對 ${leaderboard[1].correct}題)</div>` : ''}
          ${leaderboard.length > 2 ? `<div>🥉 第三名: <span class="rank-3">${leaderboard[2].name}</span> (答對 ${leaderboard[2].correct}題)</div>` : ''}
        `;
      }
      
      // 填充排行榜表格
      leaderboard.forEach((student, index) => {
        const row = document.createElement("tr");
        if (index < 3) row.className = "top3";
        
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${student.name}</td>
          <td>${student.correct}</td>
          <td>${Math.floor(student.time / 1000)}秒</td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    function updateStats(leaderboard, answers) {
      // 簡化的統計數據顯示
      document.getElementById("questionStats").innerHTML = `
        <p>總答題人次: ${answers.length}</p>
        <p>參與學生數: ${leaderboard.length}</p>
      `;
      
      document.getElementById("participationStats").
